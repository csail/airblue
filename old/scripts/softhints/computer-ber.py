#!/usr/bin/python

import sys
import numpy
import math
from optparse import OptionParser


def output_file(f, rate, bsv, log_domain, fit):
    print "// generated by compute-ber.py"
    print "// table for rate %d (%s)" % (rate, "curve fit" if fit else "exact")
    print "// (computed without odd hints)"
    print

    name = 'get_ber_r%d%s' % (rate, '_log' if log_domain else '')
    if bsv:
        print "import Real::*;"
        print
        print "function data_t %s(Bit#(8) hint)" % name
        print "      provisos (RealLiteral#(data_t), Arith#(data_t));"
        print "   case (hint) matches"
    else:
        print "double %s(UINT8 hint) {" % name
        print "   switch (hint) {"
    
    for h in range(0,64):
        ber = f(h)
        if math.isnan(ber): ber = 0

        if log_domain:
            ber = -63.0 if ber == 0 else math.log(ber, 2)
            ber = min(ber, -1)
        else:
            ber = max(ber, 0)
            ber = min(ber, 0.5)

        print "     %s %2d: return %.15f;" % ('' if bsv else ' case', h, ber)
    print "      default: return %d;" % (-63 if log_domain else 0)
    
    if bsv:
        print "   endcase"
        print "endfunction"
    else:
        print "   }"
        print "}"

def main():
    usage = "usage: %prog [options] file rate"
    parser = OptionParser(usage=usage)
    parser.add_option("-c", "--cpp", dest="filetype", default="bsv",
                      action="store_const", const="cpp", help="output C++")
    parser.add_option("-b", "--bsv", dest="filetype", default="bsv",
                      action="store_const", const="bsv", help="output BSV")
    parser.add_option("-l", "--log", dest="log", default=False,
                      action="store_true", help="output log domain")
    parser.add_option("-f", "--fit", dest="fit", default=False,
                      action="store_true", help="fit curve")
    parser.add_option("-p", "--plot", dest="plot", default=False,
                      action="store_true", help="plot curve")

    (options, args) = parser.parse_args()

    if len(args) < 1:
        parser.error("missing filename")
    if len(args) < 2:
        parser.error("missing rate")

    filename, rate = args
    rate = int(rate)
    f = open(filename, 'r')

    strs = [line.split() for line in f.read().split('\n')[:-1]]
    errors = [int(line[0]) for line in strs]
    totals = [int(line[1]) for line in strs]

    errors = numpy.array(errors, dtype='double')
    totals = numpy.array(totals, dtype='double')

    ber = numpy.log(((errors / totals) ** -1) - 1)

    idxs = numpy.nonzero(~numpy.isnan(ber) & numpy.isfinite(ber))[0]

    # ignore odd hints for now
    idxs = idxs[numpy.nonzero(idxs % 2 == 0)]

    ber = ber[idxs]

    (a,b) = numpy.polyfit(idxs, ber, 1)

    if options.fit:
        func = lambda hint: (numpy.exp(a * hint + b) + 1) ** -1
    else:
        func = lambda hint: errors[hint] / totals[hint]

    output_file(func, rate, options.filetype == 'bsv', options.log, options.fit)

    if options.plot:
        predicted = numpy.array([func(i) for i in range(len(totals))])
        ber = errors / totals

        from matplotlib import pyplot as p
        p.semilogy(ber)
        p.semilogy(predicted)
        p.show()

if __name__ == '__main__':
    main()
